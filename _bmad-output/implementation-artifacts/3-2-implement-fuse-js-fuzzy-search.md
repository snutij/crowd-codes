# Story 3.2: Implement Fuse.js Fuzzy Search

Status: done

## Story

As a **user (Lucas)**,
I want **instant search results as I type**,
So that **I find codes in under 5 seconds without waiting for network** (FR2, NFR-P5).

## Acceptance Criteria

1. **Given** `public/js/search.js` exists, **When** the page loads, **Then** Fuse.js is initialized with the codes data

2. **Given** I type in the search input, **When** I enter "nord", **Then** results appear within 200ms (NFR-P5)

3. **Given** I type in the search input, **When** I enter characters, **Then** results update on each keystroke (debounced 50ms)

4. **Given** search results exist, **When** I view the results list, **Then** codes are displayed sorted by `found_at` descending (FR3)

## Tasks / Subtasks

- [x] Task 1: Install Fuse.js dependency (AC: #1)
  - [x] Add fuse.js to package.json (already present: fuse.js@7.1.0)
  - [x] Run npm install
  - [x] Verify package-lock.json updated

- [x] Task 2: Create search.js module (AC: #1, #2, #3)
  - [x] Create `public/js/search.js` as ES module
  - [x] Import/initialize Fuse.js with appropriate options (via esm.sh CDN)
  - [x] Configure Fuse.js keys: `brand_name`, `brand_slug`, `code`
  - [x] Set appropriate threshold for fuzzy matching (0.4)
  - [x] Implement debounced search function (50ms delay)
  - [x] Bind to `#search` input element

- [x] Task 3: Load codes data (AC: #1)
  - [x] Fetch codes.json on page load
  - [x] Handle fetch errors gracefully
  - [x] Initialize Fuse.js index after data loads

- [x] Task 4: Render search results (AC: #2, #4)
  - [x] Create renderResults() function
  - [x] Generate HTML for code cards (temporary inline, refactored in Story 3.3)
  - [x] Ensure results sorted by `found_at` descending
  - [x] Display in `#results` container

- [x] Task 5: Add script to base template (AC: #1)
  - [x] Add `<script type="module" src="/js/search.js"></script>` to base.njk
  - [x] Ensure script loads after DOM ready

- [x] Task 6: Write automated tests (AC: #1, #2, #3, #4)
  - [x] Create/update tests for search functionality
  - [x] Test Fuse.js initialization
  - [x] Test debounce behavior
  - [x] Test result ordering

- [x] Task 7: Verify build and performance (AC: #2)
  - [x] Run `npm run build`
  - [x] Test search response time < 200ms (client-side only, no network)
  - [x] Test in browser with real data

## Dev Notes

### Architecture Constraints (CRITICAL)

Per `architecture.md` and `project-context.md`:

1. **File location**: `public/js/search.js` (ES module)
2. **Naming conventions**: camelCase for JS variables/functions
3. **No bundler**: Plain ES modules, Fuse.js loaded from node_modules or CDN
4. **Client-side only**: All search logic runs in browser (no network after initial load)
5. **Data source**: `src/_data/codes.json` (generated by export script)

### UX Design Requirements

Per `ux-design-specification.md`:

**SearchInput Behavior:**
- Search triggered on each keystroke (50ms debounce)
- Results appear instantly (< 200ms)
- Clear button appears when non-empty (deferred to future)

**Experience Flow:**
```
[Land on site] → [Type brand name] → [See codes instantly] → [Tap copy] → [Return to merchant]
```

**Critical timing:**
- Search → Results: < 100ms (Fuse.js client-side)
- Total search response: < 200ms (NFR-P5)

### Fuse.js Configuration

```javascript
// Recommended Fuse.js options
const fuseOptions = {
  keys: [
    { name: 'brand_name', weight: 0.7 },
    { name: 'brand_slug', weight: 0.5 },
    { name: 'code', weight: 0.3 }
  ],
  threshold: 0.4,        // Lower = stricter matching
  includeScore: true,    // For debugging/sorting
  minMatchCharLength: 2  // Ignore single characters
};
```

### Data Structure Reference

Per `architecture.md`, codes.json structure:
```json
{
  "meta": {
    "generated_at": "2026-01-18T10:30:00Z",
    "total_codes": 847,
    "total_brands": 52
  },
  "codes": [
    {
      "id": "abc123",
      "code": "NORD50",
      "brand_name": "NordVPN",
      "brand_slug": "nordvpn",
      "source_type": "youtube",
      "source_channel": "Linus Tech Tips",
      "source_video_id": "dQw4w9WgXcQ",
      "found_at": "2026-01-18T08:00:00Z",
      "confidence": 0.95
    }
  ]
}
```

### Debounce Implementation

```javascript
// Simple debounce utility
function debounce(fn, delay) {
  let timeoutId;
  return (...args) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => fn(...args), delay);
  };
}

// Usage
const debouncedSearch = debounce(performSearch, 50);
searchInput.addEventListener('input', debouncedSearch);
```

### Result Rendering (Temporary)

For this story, render minimal HTML. Story 3.3 will create proper CodeCard component.

```javascript
function renderResults(results) {
  const container = document.getElementById('results');

  if (!results.length) {
    container.innerHTML = '<p>Aucun code trouvé</p>';
    return;
  }

  // Sort by found_at descending (most recent first)
  const sorted = results.sort((a, b) =>
    new Date(b.item.found_at) - new Date(a.item.found_at)
  );

  container.innerHTML = sorted.map(({ item }) => `
    <article class="code-card">
      <code>${item.code}</code>
      <span>${item.brand_name}</span>
    </article>
  `).join('');
}
```

### Previous Story Learnings

**From Story 3.1:**
- Search input exists with `id="search"` and `autofocus`
- Results container exists with `id="results"`
- CSS classes `.search-input` and `.results-container` are defined
- Base template is `src/_includes/base.njk`
- All CSS variables from design tokens are available

### Testing Requirements

**Automated tests should verify:**
1. Fuse.js initializes without errors
2. Search responds to input events
3. Debounce delays search execution appropriately
4. Results are sorted by `found_at` descending
5. Empty query returns empty results or all results

**Browser testing:**
- Search response time < 200ms (Chrome DevTools Performance)
- Works with keyboard input
- Works on mobile (touch input)

### Dependencies

**Runtime:**
- Fuse.js v7.x (client-side fuzzy search library)

**Files:**
- Depends on: `src/_data/codes.json` (must exist from Story 2.5)
- Depends on: `src/index.njk` (search input from Story 3.1)

### Accessibility Notes

- Search results should update `aria-live` region for screen readers
- Consider announcing result count to assistive technology
- Maintain keyboard focus management

### Performance Budget

Per NFR-P6: Static Asset Size < 50KB (gzipped)
- Fuse.js minified: ~10KB gzipped
- search.js estimate: ~2KB gzipped
- Combined budget allows this addition

### References

- [Source: architecture.md#Frontend-Architecture] - Client JS structure
- [Source: ux-design-specification.md#Defining-Core-Experience] - Search flow
- [Source: ux-design-specification.md#Component-Strategy] - SearchInput spec
- [Source: prd.md#FR2] - Instant search results
- [Source: prd.md#NFR-P5] - Search Response Time < 200ms

### Project Structure Notes

**Files to create:**
```
crowd-codes/
└── public/
    └── js/
        └── search.js       # CREATE: Fuse.js search module
```

**Files to modify:**
```
crowd-codes/
├── package.json            # MODIFY: Add fuse.js dependency
└── src/
    └── _includes/
        └── base.njk        # MODIFY: Add script tag
```

### Integration Notes

- Story 3.3 will replace inline card rendering with CodeCard component
- Story 3.4 will add CopyButton to each result
- Story 3.6 will add proper empty state and error handling

### What NOT to Implement (Deferred)

- **NO CodeCard component** - Comes in Story 3.3 (use temporary inline HTML)
- **NO copy functionality** - Comes in Story 3.4
- **NO toast notifications** - Comes in Story 3.5
- **NO empty state styling** - Comes in Story 3.6
- **NO clear button** - Deferred enhancement

## Dev Agent Record

### Agent Model Used

Claude claude-opus-4-5-20251101 via Claude Code CLI

### Debug Log References

- All 118 tests passing (30 new for Story 3.2, including 7 formatRelativeDate tests)
- Build output verified: _site/js/search.js, _site/codes.json

### Completion Notes List

1. **Fuse.js loaded via CDN**: Used esm.sh CDN (`https://esm.sh/fuse.js@7.0.0`) since project has no bundler for client-side JS
2. **codes.json passthrough**: Added Eleventy passthrough copy to make codes.json accessible at `/codes.json` for client fetch
3. **Temporary CodeCard styles**: Added minimal card styles in components.css (proper CodeCard component comes in Story 3.3)
4. **French relative dates**: Implemented `formatRelativeDate()` for French locale display
5. **XSS prevention**: HTML escaping via `escapeHtml()` function
6. **Structured logging**: JSON.stringify for all console output per project-context.md
7. **Accessibility**: aria-label updated on results container for screen readers

### File List

**Created:**
- `public/js/search.js` - Fuse.js search module (229 lines)
- `tests/search.test.js` - Automated tests for Story 3.2 (269 lines)

**Modified:**
- `src/_includes/base.njk` - Added script tag for search.js
- `public/css/components.css` - Added temporary CodeCard styles
- `.eleventy.js` - Added passthrough copy for codes.json

**Modified by Code Review:**
- `public/js/search.js` - Fixed Fuse.js CDN version (7.0.0 → 7.1.0)
- `tests/search.test.js` - Improved sort test, added formatRelativeDate tests

## Senior Developer Review (AI)

**Reviewer:** Claude claude-opus-4-5-20251101
**Date:** 2026-01-19
**Outcome:** ✅ APPROVED (after fixes)

### Issues Found and Fixed

| Severity | Issue | Resolution |
|----------|-------|------------|
| MEDIUM | M2: Fuse.js version mismatch (package.json 7.1.0 vs CDN 7.0.0) | Fixed: Updated CDN import to 7.1.0 |
| MEDIUM | M3: Sort test regex too brittle | Fixed: Simplified test assertions |
| MEDIUM | M4: No tests for formatRelativeDate() | Fixed: Added 7 unit tests |

### Issues Noted (No Fix Required)

| Severity | Issue | Notes |
|----------|-------|-------|
| MEDIUM | M1: src/index.njk in git but not in File List | This file is from Story 3.1, not 3.2. Uncommitted from previous story. |
| LOW | L1-L3: Module state, escapeHtml DOM, hardcoded French | Acceptable for project scope |

### Verification

- All 118 tests passing ✓
- All 4 Acceptance Criteria implemented ✓
- Build successful ✓

## Change Log

- 2026-01-19: Code review completed, 3 issues fixed
- 2026-01-19: Story created via create-story workflow
